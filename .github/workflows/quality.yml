name: Quality Check

on:
  schedule:
    # Weekly on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  link-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Check links with Lychee
        uses: lycheeverse/lychee-action@v2
        with:
          args: --verbose --no-progress './dist/**/*.html'
          fail: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const lycheeOutput = fs.existsSync('./lychee/out.md')
              ? fs.readFileSync('./lychee/out.md', 'utf8')
              : 'Check the workflow logs for details.';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”— Broken links detected',
              body: `The weekly link check found some issues:\n\n${lycheeOutput}`,
              labels: ['bug', 'automated']
            });
