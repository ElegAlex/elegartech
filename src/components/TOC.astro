---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

// Filter to h2 and h3 only
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{tocHeadings.length > 0 && (
  <nav class="toc sticky top-24" aria-label="Table des matiÃ¨res">
    <h2 class="text-sm font-semibold mb-3 text-[var(--text-muted)] uppercase tracking-wide">
      Sommaire
    </h2>
    <ul class="space-y-2 text-sm border-l border-[var(--code-border)]">
      {tocHeadings.map((heading) => (
        <li
          class={heading.depth === 3 ? 'ml-4' : ''}
        >
          <a
            href={`#${heading.slug}`}
            class="toc-link block pl-4 py-1 -ml-px border-l-2 border-transparent text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:border-[var(--accent-primary)] transition-colors"
            data-heading={heading.slug}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  function initTOC() {
    const tocLinks = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
    const headings = Array.from(tocLinks).map((link) => {
      const id = link.getAttribute('data-heading');
      return id ? document.getElementById(id) : null;
    }).filter(Boolean) as HTMLElement[];

    if (headings.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            tocLinks.forEach((link) => {
              link.classList.remove('border-[var(--accent-primary)]', 'text-[var(--text-primary)]');
              link.classList.add('border-transparent', 'text-[var(--text-secondary)]');
            });

            const activeLink = document.querySelector<HTMLAnchorElement>(
              `.toc-link[data-heading="${entry.target.id}"]`
            );
            if (activeLink) {
              activeLink.classList.remove('border-transparent', 'text-[var(--text-secondary)]');
              activeLink.classList.add('border-[var(--accent-primary)]', 'text-[var(--text-primary)]');
            }
          }
        });
      },
      {
        rootMargin: '-80px 0px -70% 0px',
        threshold: 0,
      }
    );

    headings.forEach((heading) => observer.observe(heading));
  }

  // Run on page load
  initTOC();

  // Re-run on Astro page transitions
  document.addEventListener('astro:page-load', initTOC);
</script>
