---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import ArticleCard from '@components/ArticleCard.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => {
    return !data.draft && data.date <= new Date();
  });

  const allTags = new Set<string>();
  allPosts.forEach((post) => {
    post.data.tags.forEach((tag) => allTags.add(tag));
  });

  return Array.from(allTags).map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

const allPosts = await getCollection('blog', ({ data }) => {
  return !data.draft && data.date <= new Date();
});

const tagPosts = allPosts
  .filter((post) => post.data.tags.includes(tag!))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<BaseLayout
  title={`#${tag} | ElegarTech`}
  description={`Tous les articles tagués #${tag} sur ElegarTech.`}
>
  <section class="py-12 px-4">
    <div class="max-w-6xl mx-auto">
      <header class="mb-12">
        <a
          href="/"
          class="inline-flex items-center gap-1 text-sm text-[var(--text-secondary)] hover:text-[var(--accent-primary)] mb-4"
        >
          ← Retour à l'accueil
        </a>
        <h1 class="text-3xl md:text-4xl font-bold mb-2">
          <span class="text-[var(--accent-primary)]">#</span>{tag}
        </h1>
        <p class="text-[var(--text-secondary)]">
          {tagPosts.length} article{tagPosts.length > 1 ? 's' : ''}
        </p>
      </header>

      {tagPosts.length > 0 ? (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {tagPosts.map((post) => (
            <ArticleCard post={post} />
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <p class="text-[var(--text-secondary)]">
            Aucun article avec ce tag pour le moment.
          </p>
        </div>
      )}
    </div>
  </section>
</BaseLayout>
